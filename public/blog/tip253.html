<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tip 253 - Use Ingress Controller to access resources in an Azure Virtual Network | Kube Labs</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="apple-touch-icon" sizes="57x57" href="/kube_labs/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/kube_labs/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/kube_labs/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/kube_labs/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/kube_labs/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/kube_labs/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/kube_labs/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/kube_labs/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/kube_labs/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/kube_labs/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/kube_labs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/kube_labs/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/kube_labs/favicon-16x16.png">
  <link rel="manifest" href="/kube_labs/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <script async="true" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    
    <link rel="preload" href="/kube_labs/assets/css/0.styles.c0e6fa06.css" as="style"><link rel="preload" href="/kube_labs/assets/js/app.b33a5d98.js" as="script"><link rel="preload" href="/kube_labs/assets/js/3.90ca96aa.js" as="script"><link rel="preload" href="/kube_labs/assets/js/12.ef255ee6.js" as="script"><link rel="prefetch" href="/kube_labs/assets/js/10.93185009.js"><link rel="prefetch" href="/kube_labs/assets/js/11.b4c69ef2.js"><link rel="prefetch" href="/kube_labs/assets/js/13.f45761f9.js"><link rel="prefetch" href="/kube_labs/assets/js/14.e702dcc9.js"><link rel="prefetch" href="/kube_labs/assets/js/15.cdb1e8d4.js"><link rel="prefetch" href="/kube_labs/assets/js/16.3e581e5c.js"><link rel="prefetch" href="/kube_labs/assets/js/17.fefefc54.js"><link rel="prefetch" href="/kube_labs/assets/js/18.aab75bc5.js"><link rel="prefetch" href="/kube_labs/assets/js/19.09b9f9a2.js"><link rel="prefetch" href="/kube_labs/assets/js/4.45335c2e.js"><link rel="prefetch" href="/kube_labs/assets/js/5.389b2288.js"><link rel="prefetch" href="/kube_labs/assets/js/6.860c6127.js"><link rel="prefetch" href="/kube_labs/assets/js/7.5b82a47d.js"><link rel="prefetch" href="/kube_labs/assets/js/8.82802706.js"><link rel="prefetch" href="/kube_labs/assets/js/9.e9551f59.js"><link rel="prefetch" href="/kube_labs/assets/js/vendors~docsearch.5d51957c.js">
    <link rel="stylesheet" href="/kube_labs/assets/css/0.styles.c0e6fa06.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kube_labs/" class="home-link router-link-active"><img src="/kube_labs/files/vintage.png" alt="Kube Labs" class="logo"> <span class="site-name can-hide">Kube Labs</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kube_labs/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://videos.azuredev.tips" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Videos
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://twitch.tv/mbcrump" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Developer Live Streaming
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/Microsoft/AzureTipsAndTricks/issues/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Questions?
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://microsoft.github.io/AzureTipsAndTricks/rss.xml" class="nav-link">
  RSS Feed
</a></div> <a href="https://github.com/danielmeixner/kube_labs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kube_labs/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://videos.azuredev.tips" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Videos
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://twitch.tv/mbcrump" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Developer Live Streaming
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/Microsoft/AzureTipsAndTricks/issues/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Questions?
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://microsoft.github.io/AzureTipsAndTricks/rss.xml" class="nav-link">
  RSS Feed
</a></div> <a href="https://github.com/danielmeixner/kube_labs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Home</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/kube_labs/" class="sidebar-link">/</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kube_labs/#title-welcometype-post" class="sidebar-link">&lt;!-- ---
title: Welcome
type: post</a></li><li class="sidebar-sub-header"><a href="/kube_labs/#site-map" class="sidebar-link">Site Map</a></li><li class="sidebar-sub-header"><a href="/kube_labs/#git-workflow" class="sidebar-link">Git Workflow</a></li><li class="sidebar-sub-header"><a href="/kube_labs/#contributing" class="sidebar-link">Contributing</a></li><li class="sidebar-sub-header"><a href="/kube_labs/#legal-notices" class="sidebar-link">Legal Notices</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Tips</span> <!----></p> <ul class="sidebar-group-items"></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Recently Added</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/kube_labs/lab/lab-dev-spaces-connect.html" class="sidebar-link">10-minute Quick start: Improve debugging experience using Dev Spaces Connect</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#objective-of-the-lab" class="sidebar-link">Objective of the lab:</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#_1-deploy-the-sample-application" class="sidebar-link">1. Deploy the sample application</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#_2-visit-the-currently-running-application" class="sidebar-link">2. Visit the currently running application</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#_3-modify-the-source-code-of-your-current-application" class="sidebar-link">3. Modify the source code of your current application</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#_4-configure-aks-to-redirect-to-your-developer-machine" class="sidebar-link">4. Configure AKS to redirect to your developer machine</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#what-we-ve-seen" class="sidebar-link">What we've seen</a></li><li class="sidebar-sub-header"><a href="/kube_labs/lab/lab-dev-spaces-connect.html#learn-more" class="sidebar-link">Learn more</a></li></ul></li><li><a href="/kube_labs/blog/tip256.html" class="sidebar-link">Tip 256 - Using Application Gateway Ingress Controller with Azure Kubernetes Service (AKS)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/kube_labs/blog/tip255.html" class="sidebar-link">Tip 255 - What's Azure Private Link and how can I get started?</a></li><li><a href="/kube_labs/lab/lab.html" class="sidebar-link">/lab/lab.html</a></li></ul></div></li></ul> </div> <div class="page" data-v-e0004534> <div class="content__default" data-v-e0004534><p>::: tip</p> <p>💡 Learn more :  <a href="https://docs.microsoft.com/en-us/azure/aks/ingress-basic?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Ingress Controller in Azure Kubernetes Service<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>This article was brought to you by <a href="https://twitter.com/kumarallamraju" target="_blank" rel="noopener noreferrer">@kumarallamraju<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>:::</p> <h2 id="intro"><a href="#intro" class="header-anchor">#</a> Intro</h2> <p>In a recent customer engagement, they wanted to access all the AKS services via an Azure virtual network. This customer's application is not an external facing and needs to be on a corporate network to access their resources (e.g. HR, payroll,procurement etc..) If you are familiar with the Kubernetes eco system, we can use NGINX ingress controller to expose Kubernetes services on an external IP address. Azure Kubernetes Services comes to the rescue. AKS provides an option to deploy your NGINX ingress controller on an internal network which keeps the resources accessible only on an internal network and can be accessible via Express Route or VPN.</p> <p>In few simple steps, let's understand the process to make this happen.</p> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <p>Please make sure you have an AKS cluster provisioned and running before proceeding further. Instructions to create a new AKS cluster is documented <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>This article uses Helm to install the NGINX ingress controller, and a sample web app. You need to have Helm initialized within your AKS cluster and using a service account for Tiller. For more information on configuring and using Helm, see <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-helm" target="_blank" rel="noopener noreferrer">Install applications with Helm in AKS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_1-create-an-nginx-ingress-controller"><a href="#_1-create-an-nginx-ingress-controller" class="header-anchor">#</a> 1. Create an NGINX Ingress Controller</h2> <p>Create a file named <code>internal-ingress.yaml</code> using the following example manifest file. This example assigns 10.240.0.42 to the loadBalancerIP resource. Provide your own internal IP address for use with the ingress controller. Make sure that this IP address is not already in use within your virtual network.</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>controller:
  service:
    loadBalancerIP: 10.240.0.42
    annotations:
      service.beta.kubernetes.io/azure-load-balancer-internal: &quot;true&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_2-create-a-separate-namespace-and-ingress-controller-by-passing-the-above-file-name"><a href="#_2-create-a-separate-namespace-and-ingress-controller-by-passing-the-above-file-name" class="header-anchor">#</a> 2. Create a separate namespace and ingress controller by passing the above file name.</h2> <div class="language-text line-numbers-mode"><pre class="language-text"><code># Create a namespace for your ingress resources
kubectl create namespace ingress-basic

# Use Helm to deploy an NGINX ingress controller
helm install stable/nginx-ingress \
    --namespace ingress-basic --name mynginx-ingress \
    --set controller.replicaCount=1 \
    --set controller.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux \
    --set defaultBackend.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux \
    -f internal-ingress.yaml #[this is important]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_3-check-the-status-of-nginx-controller"><a href="#_3-check-the-status-of-nginx-controller" class="header-anchor">#</a> 3. Check the status of nginx controller</h2> <div class="language-text line-numbers-mode"><pre class="language-text"><code>kubectl get service -l app=nginx-ingress --namespace ingress-basic

It takes a minute or two to see assigned private IP in the &quot;EXTERNAL-IP&quot; section.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_4-let-s-create-some-ingress-rules-to-see-the-example-in-action"><a href="#_4-let-s-create-some-ingress-rules-to-see-the-example-in-action" class="header-anchor">#</a> 4. Let's create some ingress rules to see the example in action.</h2> <p>In this example, Helm is used to deploy two instances of a simple 'Hello world' application.</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>helm repo add azure-samples https://azure-samples.github.io/helm-charts/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_5-create-the-first-demo-application-from-a-helm-chart-with-the-following-command"><a href="#_5-create-the-first-demo-application-from-a-helm-chart-with-the-following-command" class="header-anchor">#</a> 5. Create the first demo application from a Helm chart with the following command:</h2> <div class="language-text line-numbers-mode"><pre class="language-text"><code>helm install azure-samples/aks-helloworld --namespace ingress-basic
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-now-install-a-second-instance-of-the-demo-application"><a href="#_6-now-install-a-second-instance-of-the-demo-application" class="header-anchor">#</a> 6. Now install a second instance of the demo application.</h2> <p>For the second instance, you specify a new title so that the two applications are visually distinct. You also specify a unique service name:</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>helm install azure-samples/aks-helloworld \
    --namespace ingress-basic \
    --set title=&quot;Allamraju's 2nd AKS Ingress Demo&quot; \
    --set serviceName=&quot;ingress-demo&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_7-create-an-ingress-route"><a href="#_7-create-an-ingress-route" class="header-anchor">#</a> 7. Create an Ingress Route</h2> <p>Both applications are now running on your Kubernetes cluster. To route traffic to each application, create a Kubernetes ingress resource. The ingress resource configures the rules that route traffic to one of the two applications.</p> <p>In the following example, traffic to the address http://10.240.0.42/ is routed to the service named aks-helloworld. Traffic to the address http://10.240.0.42/hello-world-two is routed to the ingress-demo service.</p> <p>Create a file named <code>hello-world-ingress-internalIP.yaml</code> and copy in the following example YAML.</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: hello-world-ingress
  namespace: ingress-basic
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;
    nginx.ingress.kubernetes.io/rewrite-target: /$1
spec:
  rules:
  - http:
      paths:
      - backend:
          serviceName: aks-helloworld
          servicePort: 80
        path: /(.*)
      - backend:
          serviceName: ingress-demo
          servicePort: 80
        path: /hello-world-two(/|$)(.*)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="_8-deploy-this-resource-to-your-kubernetes-cluster-using-kubectl-command"><a href="#_8-deploy-this-resource-to-your-kubernetes-cluster-using-kubectl-command" class="header-anchor">#</a> 8. Deploy this resource to your Kubernetes cluster using kubectl command</h2> <div class="language-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f hello-world-ingress.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_9-time-to-validate-the-ingress-controller"><a href="#_9-time-to-validate-the-ingress-controller" class="header-anchor">#</a> 9. Time to validate the ingress controller</h2> <p>To test the routes for the ingress controller, browse to the two applications pointing your web browser to http://10.240.0.42. But to resolve this IP you need to access this IP via Express Route or VPN from your on-premises network. If needed, you can quickly test this internal-only functionality from a pod on the AKS cluster. Create a test pod and attach a terminal session to it:</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>kubectl run -it --rm aks-ingress-test --image=debian --namespace ingress-basic

apt-get update &amp;&amp; apt-get install -y curl
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>curl -L http://10.240.0.42
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/static/default.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Welcome to Azure Kubernetes Service (AKS)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
[...]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>curl -L -k http://10.240.0.42/hello-world-two
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/static/default.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>KS Ingress Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
[...]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Once you are done validating this functionality, please do not forget to clean up the resources</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>helm repo remove azure-samples

helm ls --all mynginx-ingress --namespace ingress-basic
helm del --purge mynginx-ingress

kubectl delete -f hello-world-ingress-internalIP.yaml

kubectl delete namespace ingress-basic
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>By default, an NGINX ingress controller is created with a dynamic public IP address assignment. A common configuration requirement is to use an internal, private network and IP address. The approach discussed above allows you to restrict access to your services to internal users, with no external access via public internet.</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><p><a href="https://docs.microsoft.com/en-us/azure/aks/ingress-internal-ip?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Ingress Controller in an Azure Virtual Network<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/?WT.mc_id=docs-azuredevtips-micrum" target="_blank" rel="noopener noreferrer">Overview of Kubernetes Ingress<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <div class="page-edit" data-v-e0004534><div class="edit-link" data-v-e0004534><a href="https://github.com/danielmeixner/kube_labs/edit/master/blog/tip253.md" target="_blank" rel="noopener noreferrer" data-v-e0004534>Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e0004534 data-v-e0004534><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <section class="share" data-v-e0004534><h2 data-v-e0004534>Share</h2> <a href="https://twitter.com/intent/tweet?text=Tip 253 - Use Ingress Controller to access resources in an Azure Virtual Network by @mbcrump undefined/blog/tip253.html" target="_blank" class="share__button" data-v-e0004534><i class="fab fa-twitter" data-v-e0004534></i> Tweet
    </a></section></div> <!----></div> <!----> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/kube_labs/assets/js/app.b33a5d98.js" defer></script><script src="/kube_labs/assets/js/3.90ca96aa.js" defer></script><script src="/kube_labs/assets/js/12.ef255ee6.js" defer></script>
  </body>
</html>
